name: Working Config Test

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup and Fix Permissions
      run: |
        sudo apt update
        sudo apt install -y build-essential gcc-aarch64-linux-gnu bc flex bison libelf-dev
        
        # ä¿®å¤è„šæœ¬æƒé™
        echo "ğŸ”§ ä¿®å¤è„šæœ¬æƒé™..."
        find scripts -name "*.sh" -exec chmod +x {} \; 2>/dev/null || echo "éƒ¨åˆ†æƒé™ä¿®å¤å®Œæˆ"
        
        # å¤„ç†KernelSUé…ç½®ç¼ºå¤±
        echo "ğŸ“ å¤„ç†KernelSUé…ç½®..."
        if [ ! -d "drivers/kernelsu" ]; then
          mkdir -p drivers/kernelsu
          echo 'config KSU' > drivers/kernelsu/Kconfig
          echo '    bool "KernelSU"' >> drivers/kernelsu/Kconfig
          echo '    default n' >> drivers/kernelsu/Kconfig
          echo "âœ… åˆ›å»ºKernelSUå ä½é…ç½®"
        fi

    - name: Build (Simple)
      run: |
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        echo "âš™ï¸ å¼€å§‹é…ç½®..."
        # ä½¿ç”¨é»˜è®¤é…ç½®ï¼Œä¸åˆ›å»ºoutç›®å½•
        make alioth_defconfig
        echo "âœ… é…ç½®å®Œæˆ"
        
        echo "ğŸ”¨ å¼€å§‹æ„å»º..."
        make -j2
        echo "âœ… æ„å»ºå®Œæˆ"
        
        # æ£€æŸ¥è¾“å‡º
        if [ -f "arch/arm64/boot/Image.gz-dtb" ]; then
          echo "ğŸ‰ æ„å»ºæˆåŠŸï¼"
          ls -lh arch/arm64/boot/Image.gz-dtb
        else
          echo "âŒ æ— è¾“å‡ºæ–‡ä»¶ï¼Œæ£€æŸ¥é”™è¯¯..."
          find . -name "*log" -type f | head -5
        fi
